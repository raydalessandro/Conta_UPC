<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d0d14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Saldi Scanner</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Barcode Detector Polyfill (il segreto del successo!) -->
    <script type="module">
        import "https://fastly.jsdelivr.net/npm/barcode-detector@3/dist/es/polyfill.min.js";
    </script>
    
    <style>
        :root {
            --bg-primary: #0d0d14;
            --bg-secondary: #16161f;
            --bg-tertiary: #1e1e2a;
            --text-primary: #ffffff;
            --text-secondary: #b4b4b4;
            --text-muted: #6b6b6b;
            --accent-green: #00e676;
            --accent-red: #ff5252;
            --accent-yellow: #ffd740;
            --accent-blue: #448aff;
            --radius: 12px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
        }
        
        #app { 
            height: 100vh; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
        }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent-green); color: #000; }
        .btn-primary:active { transform: scale(0.97); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-danger { background: rgba(255,82,82,0.15); color: var(--accent-red); }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-lg { padding: 18px 32px; font-size: 17px; }
        .w-full { width: 100%; }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 12px;
        }
        
        /* Scanner Styles */
        #scanner-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scan-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .scan-frame {
            width: 85%;
            max-width: 320px;
            height: 120px;
            border: 3px solid var(--accent-green);
            border-radius: 16px;
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .scan-line {
            position: absolute;
            top: 50%;
            left: 10px;
            right: 10px;
            height: 2px;
            background: var(--accent-green);
            animation: scan 1.5s ease-in-out infinite;
        }
        
        @keyframes scan {
            0%, 100% { opacity: 1; transform: translateY(-20px); }
            50% { opacity: 0.5; transform: translateY(20px); }
        }
        
        /* Feedback Overlay */
        .feedback-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            animation: fadeIn 0.15s ease;
        }
        
        .feedback-overlay.success { background: rgba(0, 230, 118, 0.15); }
        .feedback-overlay.error { background: rgba(255, 82, 82, 0.15); }
        .feedback-overlay.warning { background: rgba(255, 215, 64, 0.15); }
        
        .feedback-box {
            padding: 32px 48px;
            background: var(--bg-secondary);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 60px rgba(0,0,0,0.5);
        }
        
        .feedback-overlay.success .feedback-box { border: 3px solid var(--accent-green); }
        .feedback-overlay.error .feedback-box { border: 3px solid var(--accent-red); }
        .feedback-overlay.warning .feedback-box { border: 3px solid var(--accent-yellow); }
        
        .feedback-message {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .feedback-overlay.success .feedback-message { color: var(--accent-green); }
        .feedback-overlay.error .feedback-message { color: var(--accent-red); }
        .feedback-overlay.warning .feedback-message { color: var(--accent-yellow); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Utility */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .p-4 { padding: 16px; }
        .p-5 { padding: 20px; }
        .text-center { text-align: center; }
        .overflow-auto { overflow: auto; }
        .relative { position: relative; }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script type="text/babel">
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(e => console.log('SW error:', e));
        }

        const { useState, useEffect, useRef, useCallback, createContext, useContext, useMemo } = React;

        // ============================================================
        // STORAGE
        // ============================================================
        const Storage = {
            PREFIX: 'saldi_scanner_',
            get(k, d = null) { try { const v = localStorage.getItem(this.PREFIX + k); return v ? JSON.parse(v) : d; } catch { return d; } },
            set(k, v) { try { localStorage.setItem(this.PREFIX + k, JSON.stringify(v)); } catch {} },
            remove(k) { try { localStorage.removeItem(this.PREFIX + k); } catch {} }
        };

        // UPC helpers: try multiple normalizations to catch faded / legacy codes
        const normalizeUpcCandidates = (raw) => {
            const digits = String(raw || '').replace(/[^0-9]/g, '');
            if (!digits) return [];
            if (digits.length < 10 || digits.length > 14) return [];
            const set = new Set();
            const pad13 = digits.padStart(13, '0').slice(-13);
            set.add(pad13);
            if (digits.length === 12) set.add(('0' + digits).slice(-13));
            if (digits.length === 13 && digits.startsWith('0')) set.add(digits.substring(1).padStart(13, '0'));
            if (digits.length === 8) set.add(digits.padStart(13, '0'));
            return Array.from(set);
        };

        // Corporate parser helpers (from provided standalone tool)
        const readCorporateExcel = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                    resolve(json);
                } catch (err) {
                    reject(new Error('Errore lettura file Excel: ' + err.message));
                }
            };
            reader.onerror = () => reject(new Error('Errore lettura file'));
            reader.readAsArrayBuffer(file);
        });

        const extractStores = (data) => {
            const storesMap = {};
            data.forEach(row => {
                const code = row['CODICE SAP'];
                const name = row['NOME NEGOZIO'];
                if (code && name) {
                    if (!storesMap[code]) storesMap[code] = { code, name, count: 0 };
                    storesMap[code].count++;
                }
            });
            return Object.values(storesMap).sort((a, b) => a.code.localeCompare(b.code));
        };

        const extractStoreArticles = (data, storeCode) => {
            const articlesMap = {};
            data.forEach(row => {
                if (row['CODICE SAP'] !== storeCode) return;

                let upc = String(row['UPC'] || '').replace(/[^0-9]/g, '');
                if (upc.length < 8 || upc.length > 14) return;
                upc = upc.padStart(13, '0');

                const qty = parseInt(row['On-Hand Units']) || 1;

                let modello = String(row['MODELLO'] || '').trim();
                if (modello.startsWith('0')) modello = modello.substring(1);

                const brand = String(row['BRAND'] || '').trim();

                let sconto = row['SALDI ESTIVI 2025'];
                if (typeof sconto === 'string' && sconto.includes('70')) {
                    sconto = 70;
                } else if (typeof sconto === 'number') {
                    sconto = Math.round(sconto * 100);
                } else {
                    sconto = 30;
                }

                const prezzoOrig = parseFloat(row['PREZZO AS IS']) || 0;
                const prezzoSaldo = parseFloat(row['PREZZO TO BE']) || 0;

                if (articlesMap[upc]) {
                    articlesMap[upc].qty += qty;
                } else {
                    articlesMap[upc] = {
                        upc,
                        qty,
                        modello,
                        brand,
                        sconto,
                        prezzoOrig: Math.round(prezzoOrig * 100) / 100,
                        prezzoSaldo: Math.round(prezzoSaldo * 100) / 100
                    };
                }
            });
            return Object.values(articlesMap);
        };

        const buildCorporatePayload = (storeArticles, store) => {
            const saldiMap = {};
            const discountCount = {};
            let totalQty = 0;
            storeArticles.forEach(a => {
                saldiMap[a.upc] = a.qty;
                totalQty += a.qty;
                discountCount[a.sconto] = (discountCount[a.sconto] || 0) + 1;
            });
            return {
                saldiMap,
                meta: {
                    store,
                    loadedAt: new Date().toISOString(),
                    totalModels: storeArticles.length,
                    totalQty,
                    discountCount
                },
                articles: storeArticles
            };
        };

        // ============================================================
        // CONTEXT
        // ============================================================
        const AppContext = createContext(null);
        const useApp = () => useContext(AppContext);

        function AppProvider({ children }) {
            const [view, setView] = useState('home');
            const [saldiList, setSaldiList] = useState(() => Storage.get('list', {}));
            const [scans, setScans] = useState(() => Storage.get('scans', {}));
            const [currentPanel, setCurrentPanel] = useState(() => Storage.get('panel', 'Pannello 1'));
            const [panels, setPanels] = useState(() => Storage.get('panels', ['Pannello 1']));
            const [feedback, setFeedback] = useState(null);
            const [meta, setMeta] = useState(() => Storage.get('meta', null));
            const [storeArticles, setStoreArticles] = useState(() => Storage.get('store_articles', []));

            useEffect(() => { Storage.set('list', saldiList); }, [saldiList]);
            useEffect(() => { Storage.set('scans', scans); }, [scans]);
            useEffect(() => { Storage.set('panel', currentPanel); }, [currentPanel]);
            useEffect(() => { Storage.set('panels', panels); }, [panels]);
            useEffect(() => { Storage.set('meta', meta); }, [meta]);
            useEffect(() => { Storage.set('store_articles', storeArticles); }, [storeArticles]);

            const applyCorporateData = useCallback(({ saldiMap, meta, articles }) => {
                setSaldiList(saldiMap);
                setMeta(meta);
                setStoreArticles(articles);
                setScans({});
                setPanels(['Pannello 1']);
                setCurrentPanel('Pannello 1');
            }, []);

            const handleScan = useCallback((rawUpc) => {
                const candidates = normalizeUpcCandidates(rawUpc);
                if (!candidates.length) return;
                const actualUpc = candidates.find(c => c in saldiList) || candidates[0];
                const isSaldo = Boolean(actualUpc && actualUpc in saldiList);
                const totalQty = isSaldo ? saldiList[actualUpc] : 0;
                const panelScans = scans[currentPanel] || [];
                const prevCount = panelScans.filter(s => s.upc === actualUpc).length;

                setScans(prev => {
                    const current = [...(prev[currentPanel] || []), { upc: actualUpc, timestamp: Date.now(), isSaldo, count: prevCount + 1, total: totalQty }];
                    const MAX_HISTORY = 5000;
                    const trimmed = current.length > MAX_HISTORY ? current.slice(current.length - MAX_HISTORY) : current;
                    return { ...prev, [currentPanel]: trimmed };
                });

                let type, message;
                if (!isSaldo) { type = 'error'; message = 'NON IN SALDO'; }
                else if (prevCount >= totalQty) { type = 'warning'; message = `ECCEDENZA ${prevCount + 1}/${totalQty}`; }
                else { type = 'success'; message = `SALDO ${prevCount + 1}/${totalQty}`; }

                setFeedback({ type, message, upc: actualUpc });
                navigator.vibrate?.(type === 'success' ? [100] : type === 'warning' ? [100, 50, 100] : [200]);
                setTimeout(() => setFeedback(null), 1500);
            }, [saldiList, scans, currentPanel]);

            const getStats = useCallback((panel = currentPanel) => {
                const s = scans[panel] || [];
                const saldi = s.filter(x => x.isSaldo);
                const uniqueUPCs = [...new Set(saldi.map(x => x.upc))];
                let eccedenze = 0;
                uniqueUPCs.forEach(upc => { if (saldi.filter(x => x.upc === upc).length > (saldiList[upc] || 0)) eccedenze++; });
                return { total: s.length, saldiFound: saldi.length, notSaldi: s.filter(x => !x.isSaldo).length, uniqueSaldi: uniqueUPCs.length, eccedenze };
            }, [scans, saldiList, currentPanel]);

            const clearAll = useCallback(() => {
                setSaldiList({});
                setPanels(['Pannello 1']);
                setCurrentPanel('Pannello 1');
                setScans({});
                setMeta(null);
                setStoreArticles([]);
                Storage.remove('meta');
                Storage.remove('store_articles');
            }, []);

            const value = useMemo(() => ({
                view, setView, saldiList, scans, currentPanel, setCurrentPanel, panels, setPanels, feedback, 
                handleScan, getStats, clearAll, fileLoaded: Object.keys(saldiList).length > 0, meta, storeArticles, applyCorporateData
            }), [view, saldiList, scans, currentPanel, panels, feedback, handleScan, getStats, clearAll, meta, storeArticles, applyCorporateData]);

            return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
        }

        // ============================================================
        // FEEDBACK OVERLAY
        // ============================================================
        function FeedbackOverlay() {
            const { feedback } = useApp();
            if (!feedback) return null;
            return (
                <div className={`feedback-overlay ${feedback.type}`}>
                    <div className="feedback-box">
                        <div className="feedback-message mono">{feedback.message}</div>
                        <div className="mono" style={{ color: '#888', fontSize: 14 }}>{feedback.upc}</div>
                    </div>
                </div>
            );
        }

        // ============================================================
        // SCANNER (con BarcodeDetector polyfillato - FUNZIONA!)
        // ============================================================
        function ScannerView() {
            const { setView, handleScan, scans, currentPanel, getStats } = useApp();
            const stats = getStats();
            const lastScan = scans[currentPanel]?.slice(-1)[0];
            
            const videoRef = useRef(null);
            const streamRef = useRef(null);
            const detectorRef = useRef(null);
            const lastScanRef = useRef({ code: '', time: 0 });
            const animationRef = useRef(null);
            
            const [status, setStatus] = useState('loading');
            const [error, setError] = useState(null);
            const [manualUpc, setManualUpc] = useState('');
            
            const DEBOUNCE = 700; // 0.7s safety gap to avoid duplicates in burst scans

            useEffect(() => {
                let mounted = true;

                const init = async () => {
                    try {
                        // Aspetta che il polyfill sia caricato
                        if (typeof BarcodeDetector === 'undefined') {
                            await new Promise(r => setTimeout(r, 500));
                            if (typeof BarcodeDetector === 'undefined') {
                                throw new Error('BarcodeDetector non disponibile');
                            }
                        }

                        // Crea il detector
                        detectorRef.current = new BarcodeDetector({
                            formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'code_39']
                        });

                        // Ottieni stream video con fallback legacy
                        const legacyGetUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                        const getStream = navigator.mediaDevices?.getUserMedia
                            ? (constraints) => navigator.mediaDevices.getUserMedia(constraints)
                            : (legacyGetUserMedia
                                ? (constraints) => new Promise((resolve, reject) => legacyGetUserMedia.call(navigator, constraints, resolve, reject))
                                : null);

                        if (!getStream) {
                            throw new Error('Camera non disponibile: usa HTTPS/localhost e consenti i permessi.');
                        }

                        const stream = await getStream({
                            video: {
                                facingMode: { ideal: 'environment' },
                                width: { ideal: 1920 },
                                height: { ideal: 1080 }
                            },
                            audio: false
                        });

                        if (!mounted) { stream.getTracks().forEach(t => t.stop()); return; }
                        
                        streamRef.current = stream;
                        
                        if (videoRef.current) {
                            videoRef.current.srcObject = stream;
                            await videoRef.current.play();
                        }

                        setStatus('scanning');

                        // Loop di scansione
                        const scanLoop = async () => {
                            if (!mounted || !videoRef.current || !detectorRef.current) return;
                            
                            try {
                                const barcodes = await detectorRef.current.detect(videoRef.current);
                                
                                if (barcodes.length > 0) {
                                    const code = barcodes[0].rawValue;
                                    const now = Date.now();
                                    
                                    if (now - lastScanRef.current.time >= DEBOUNCE || code !== lastScanRef.current.code) {
                                        lastScanRef.current = { code, time: now };
                                        handleScan(code);
                                    }
                                }
                            } catch (e) {
                                // Normale se non trova barcode
                            }
                            
                            if (mounted) {
                                animationRef.current = requestAnimationFrame(scanLoop);
                            }
                        };
                        
                        scanLoop();

                    } catch (err) {
                        if (mounted) {
                            setStatus('error');
                            setError(err.message || 'Errore camera');
                        }
                    }
                };

                init();

                return () => {
                    mounted = false;
                    if (animationRef.current) cancelAnimationFrame(animationRef.current);
                    if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
                };
            }, [handleScan]);

            const handleManual = () => {
                const digits = manualUpc.replace(/[^0-9]/g, '');
                if (!digits) return;
                if (digits.length < 10 || digits.length > 14) {
                    alert('Inserisci un UPC tra 10 e 14 cifre');
                    return;
                }
                handleScan(manualUpc.trim());
                setManualUpc('');
            };

            return (
                <div className="flex flex-col flex-1" style={{ background: '#000' }}>
                    {/* Header */}
                    <div className="flex items-center justify-between p-4" style={{ background: 'var(--bg-secondary)' }}>
                        <button className="btn btn-sm btn-secondary" onClick={() => setView('home')}>‚Üê Esci</button>
                        <span style={{ fontSize: 13, color: '#888' }}>{currentPanel}</span>
                        <div className="mono" style={{ fontSize: 14 }}>
                            <span style={{ color: 'var(--accent-green)' }}>{stats.saldiFound}</span>
                            <span style={{ color: '#555' }}> / </span>
                            <span style={{ color: 'var(--accent-red)' }}>{stats.notSaldi}</span>
                        </div>
                    </div>

                    {/* Scanner */}
                    <div className="flex-1 relative" style={{ overflow: 'hidden' }}>
                        <div id="scanner-container">
                            <video ref={videoRef} playsInline autoPlay muted style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            
                            {status === 'scanning' && (
                                <div className="scan-overlay">
                                    <div className="scan-frame">
                                        <div className="scan-line" />
                                    </div>
                                </div>
                            )}
                        </div>

                        {status === 'loading' && (
                            <div className="flex flex-col items-center justify-center" style={{ position: 'absolute', inset: 0, background: 'var(--bg-primary)' }}>
                                <div style={{ fontSize: 48, marginBottom: 16 }}>üì∑</div>
                                <p style={{ color: '#888' }}>Avvio scanner...</p>
                            </div>
                        )}

                        {status === 'error' && (
                            <div className="flex flex-col items-center justify-center p-5 text-center" style={{ position: 'absolute', inset: 0, background: 'var(--bg-primary)' }}>
                                <div style={{ fontSize: 48, marginBottom: 16 }}>‚ö†Ô∏è</div>
                                <p style={{ color: 'var(--accent-red)', marginBottom: 16 }}>{error}</p>
                                <button className="btn btn-primary" onClick={() => location.reload()}>üîÑ Ricarica</button>
                            </div>
                        )}
                    </div>

                    {/* Manual Input */}
                    <div className="flex gap-2 p-4" style={{ background: 'var(--bg-secondary)' }}>
                        <input
                            type="tel"
                            inputMode="numeric"
                            pattern="[0-9]*"
                            minLength={10}
                            maxLength={14}
                            placeholder="UPC manuale..."
                            value={manualUpc}
                            onChange={e => setManualUpc(e.target.value)}
                            onKeyDown={e => e.key === 'Enter' && handleManual()}
                            className="mono"
                            style={{ flex: 1, padding: 12, borderRadius: 'var(--radius)', border: '1px solid #333', background: 'var(--bg-tertiary)', color: '#fff', fontSize: 16 }}
                        />
                        <button className="btn btn-primary" onClick={handleManual} disabled={!manualUpc.trim()}>‚úì</button>
                    </div>

                    {/* Last Scan */}
                    {lastScan && (
                        <div className="flex items-center justify-between p-4" style={{
                            background: lastScan.isSaldo ? 'rgba(0,230,118,0.1)' : 'rgba(255,82,82,0.1)',
                            borderTop: `2px solid ${lastScan.isSaldo ? 'var(--accent-green)' : 'var(--accent-red)'}`
                        }}>
                            <div>
                                <div className="mono" style={{ fontSize: 16, fontWeight: 600, color: lastScan.isSaldo ? 'var(--accent-green)' : 'var(--accent-red)' }}>
                                    {lastScan.upc}
                                </div>
                                <div style={{ fontSize: 12, color: '#888' }}>{lastScan.isSaldo ? '‚úì Saldo' : '‚úó No saldo'}</div>
                            </div>
                            {lastScan.isSaldo && (
                                <div className="mono" style={{
                                    padding: '8px 14px', borderRadius: 8, fontWeight: 700,
                                    background: lastScan.count > lastScan.total ? 'var(--accent-yellow)' : 'var(--accent-green)',
                                    color: '#000'
                                }}>
                                    {lastScan.count}/{lastScan.total}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // ============================================================
        // HOME
        // ============================================================
        function HomeView() {
            const { setView, saldiList, clearAll, getStats, currentPanel, panels, setCurrentPanel, setPanels, fileLoaded, meta } = useApp();
            const stats = getStats();

            const addPanel = () => {
                const name = prompt('Nome pannello:');
                if (name?.trim() && !panels.includes(name.trim())) {
                    setPanels([...panels, name.trim()]);
                    setCurrentPanel(name.trim());
                }
            };

            return (
                <div className="flex flex-col flex-1 overflow-auto p-5">
                    {/* Header */}
                    <header className="text-center" style={{ padding: '24px 0' }}>
                        <h1 style={{ fontSize: 32, fontWeight: 700, background: 'linear-gradient(135deg, var(--accent-green), var(--accent-blue))', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                            SALDI SCANNER
                        </h1>
                        <p style={{ color: '#888', fontSize: 14, marginTop: 6 }}>Scansiona ‚Ä¢ Verifica ‚Ä¢ Organizza</p>
                    </header>

                    {/* Panel */}
                    <div className="card flex items-center justify-between" style={{ cursor: 'pointer' }} onClick={addPanel}>
                        <span>üìã {currentPanel}</span>
                        <span style={{ color: '#888', fontSize: 13 }}>+ Nuovo</span>
                    </div>

                    {panels.length > 1 && (
                        <div className="flex gap-2" style={{ marginBottom: 12, overflowX: 'auto', paddingBottom: 4 }}>
                            {panels.map(p => (
                                <button key={p} onClick={() => setCurrentPanel(p)} style={{
                                    padding: '8px 16px', borderRadius: 20, border: `1px solid ${p === currentPanel ? 'var(--accent-green)' : '#333'}`,
                                    background: p === currentPanel ? 'rgba(0,230,118,0.1)' : 'transparent',
                                    color: p === currentPanel ? 'var(--accent-green)' : '#888', fontSize: 13, cursor: 'pointer', whiteSpace: 'nowrap'
                                }}>
                                    {p}
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Stats */}
                    <div className="card">
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16 }}>
                            <div className="text-center">
                                <div className="mono" style={{ fontSize: 28, fontWeight: 700, color: 'var(--accent-blue)' }}>{Object.keys(saldiList).length}</div>
                                <div style={{ fontSize: 11, color: '#888' }}>LISTA SALDI</div>
                            </div>
                            <div className="text-center">
                                <div className="mono" style={{ fontSize: 28, fontWeight: 700 }}>{stats.total}</div>
                                <div style={{ fontSize: 11, color: '#888' }}>SCANSIONATI</div>
                            </div>
                            <div className="text-center">
                                <div className="mono" style={{ fontSize: 28, fontWeight: 700, color: 'var(--accent-green)' }}>{stats.saldiFound}</div>
                                <div style={{ fontSize: 11, color: '#888' }}>TROVATI</div>
                            </div>
                            <div className="text-center">
                                <div className="mono" style={{ fontSize: 28, fontWeight: 700, color: 'var(--accent-red)' }}>{stats.notSaldi}</div>
                                <div style={{ fontSize: 11, color: '#888' }}>NO SALDI</div>
                            </div>
                        </div>
                        {meta && (
                            <div style={{ marginTop: 12, padding: 10, background: 'rgba(68,138,255,0.1)', borderRadius: 8, color: 'var(--accent-blue)', fontSize: 13 }}>
                                Negozio: {meta.store?.code} ¬∑ {meta.store?.name}<br />
                                Modelli: {meta.totalModels} ‚Ä¢ Pezzi: {meta.totalQty}
                            </div>
                        )}
                        {stats.eccedenze > 0 && (
                            <div style={{ marginTop: 12, padding: 10, background: 'rgba(255,215,64,0.1)', borderRadius: 8, color: 'var(--accent-yellow)', fontSize: 13, textAlign: 'center' }}>
                                ‚ö†Ô∏è {stats.eccedenze} eccedenze
                            </div>
                        )}
                    </div>

                    {/* Upload (corporate parser flow) */}
                    <button data-testid="open-loader" className="btn w-full btn-primary" onClick={() => setView('loader')}>
                        üìÅ Carica File Corporate
                    </button>

                    {/* Scanner */}
                    {fileLoaded && (
                        <button data-testid="start-scanner" className="btn btn-primary btn-lg w-full" style={{ marginTop: 12 }} onClick={() => setView('scanner')}>
                            üì∑ AVVIA SCANNER
                        </button>
                    )}

                    {/* History */}
                    {stats.total > 0 && (
                        <button className="btn btn-secondary w-full" style={{ marginTop: 12 }} onClick={() => setView('history')}>
                            üìú Storico ({stats.total})
                        </button>
                    )}

                    <div style={{ flex: 1 }} />

                    {/* Reset */}
                    <button className="btn btn-danger btn-sm w-full" style={{ marginTop: 20, opacity: 0.7 }} onClick={() => confirm('Reset tutto?') && clearAll()}>
                        üóë Reset
                    </button>
                </div>
            );
        }

        // ============================================================
        // HISTORY
        // ============================================================
        function HistoryView() {
            const { setView, scans, currentPanel, saldiList } = useApp();
            const panelScans = scans[currentPanel] || [];
            
            const summary = useMemo(() => {
                const grouped = {};
                panelScans.forEach(s => {
                    if (!grouped[s.upc]) grouped[s.upc] = { upc: s.upc, count: 0, total: saldiList[s.upc] || 0, isSaldo: s.isSaldo, time: s.timestamp };
                    grouped[s.upc].count++;
                    grouped[s.upc].time = Math.max(grouped[s.upc].time, s.timestamp);
                });
                return Object.values(grouped).sort((a, b) => b.time - a.time);
            }, [panelScans, saldiList]);

            return (
                <div className="flex flex-col flex-1">
                    <div className="flex items-center justify-between p-4" style={{ background: 'var(--bg-secondary)', borderBottom: '1px solid #222' }}>
                        <button className="btn btn-sm btn-secondary" onClick={() => setView('home')}>‚Üê Indietro</button>
                        <span style={{ fontWeight: 600 }}>üìú {currentPanel}</span>
                        <div style={{ width: 80 }} />
                    </div>
                    
                    <div className="flex-1 overflow-auto p-4">
                        {summary.length === 0 ? (
                            <div className="text-center" style={{ padding: 40, color: '#888' }}>Nessuna scansione</div>
                        ) : summary.map(item => (
                            <div key={item.upc} style={{
                                padding: 14, background: 'var(--bg-secondary)', borderRadius: 10, marginBottom: 10,
                                borderLeft: `4px solid ${!item.isSaldo ? 'var(--accent-red)' : item.count > item.total ? 'var(--accent-yellow)' : 'var(--accent-green)'}`
                            }}>
                                <div className="flex items-center justify-between">
                                    <div className="mono" style={{ fontSize: 14 }}>{item.upc}</div>
                                    {item.isSaldo ? (
                                        <div className="mono" style={{
                                            padding: '4px 10px', borderRadius: 6, fontSize: 13, fontWeight: 600,
                                            background: item.count > item.total ? 'rgba(255,215,64,0.2)' : 'rgba(0,230,118,0.2)',
                                            color: item.count > item.total ? 'var(--accent-yellow)' : 'var(--accent-green)'
                                        }}>{item.count}/{item.total}</div>
                                    ) : (
                                        <div style={{ padding: '4px 10px', background: 'rgba(255,82,82,0.2)', color: 'var(--accent-red)', borderRadius: 6, fontSize: 11 }}>NO</div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // ============================================================
        // CORPORATE LOADER (multi-step parser)
        // ============================================================
        function CorporateLoader() {
            const { setView, applyCorporateData } = useApp();
            const [step, setStep] = useState(1);
            const [loadingStatus, setLoadingStatus] = useState('');
            const [error, setError] = useState('');
            const [stores, setStores] = useState([]);
            const [rawData, setRawData] = useState([]);
            const [selectedStore, setSelectedStore] = useState(null);
            const [storeArticles, setStoreArticles] = useState([]);
            const [search, setSearch] = useState('');

            const goHome = () => setView('home');

            const onFile = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                setError('');
                setStep(2);
                setLoadingStatus('Lettura file...');
                try {
                    const data = await readCorporateExcel(file);
                    setRawData(data);
                    setLoadingStatus('Estrazione negozi...');
                    const list = extractStores(data);
                    if (!list.length) throw new Error('Nessun negozio trovato nel file');
                    setStores(list);
                    setStep(3);
                } catch (err) {
                    setError(err.message || 'Errore file');
                    setStep(1);
                } finally {
                    e.target.value = '';
                }
            };

            const chooseStore = (store) => {
                setSelectedStore(store);
                const articles = extractStoreArticles(rawData, store.code);
                setStoreArticles(articles);
                setStep(4);
            };

            const confirmStore = () => {
                if (!selectedStore || !storeArticles.length) return;
                const payload = buildCorporatePayload(storeArticles, selectedStore);
                applyCorporateData(payload);
                setView('home');
            };

            const filteredStores = stores.filter(s => s.code.toLowerCase().includes(search.toLowerCase()) || s.name.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="flex flex-col flex-1 overflow-auto">
                    <div className="flex items-center justify-between p-4" style={{ background: 'var(--bg-secondary)', borderBottom: '1px solid #222' }}>
                        <button className="btn btn-sm btn-secondary" onClick={goHome}>‚Üê Home</button>
                        <span style={{ fontWeight: 600 }}>Carica corporate</span>
                        <div style={{ width: 80 }} />
                    </div>

                    <div className="p-5 flex-1">
                        {step === 1 && (
                            <div className="card">
                                <div style={{ fontWeight: 600, marginBottom: 8 }}>üìÅ Carica File Excel</div>
                                <p style={{ color: '#888', fontSize: 14, marginBottom: 16 }}>Seleziona il file corporate (non modificato).</p>
                                <input data-testid="file-input" type="file" accept=".xlsx,.xls" onChange={onFile} style={{ display: 'none' }} id="corporate-file" />
                                <button className="btn btn-primary w-full" onClick={() => document.getElementById('corporate-file').click()}>Seleziona File</button>
                                {error && <div style={{ marginTop: 12, padding: 12, borderRadius: 8, background: 'rgba(255,82,82,0.1)', color: 'var(--accent-red)', fontSize: 13 }}>{error}</div>}
                            </div>
                        )}

                        {step === 2 && (
                            <div className="card text-center">
                                <div style={{ fontSize: 40, marginBottom: 12 }}>‚è≥</div>
                                <div>Analisi file in corso...</div>
                                <div style={{ color: '#888', fontSize: 12, marginTop: 6 }}>{loadingStatus}</div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="card">
                                <div style={{ fontWeight: 600, marginBottom: 12 }}>üè™ Seleziona il tuo Negozio</div>
                                <input
                                    value={search}
                                    onChange={e => setSearch(e.target.value)}
                                    placeholder="üîç Cerca per nome o codice..."
                                    style={{ width: '100%', padding: 12, borderRadius: 'var(--radius)', border: '1px solid #333', background: 'var(--bg-tertiary)', color: '#fff', marginBottom: 12 }}
                                />
                                <div style={{ maxHeight: 360, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: 8 }}>
                                    {filteredStores.map(s => (
                                        <div key={s.code} onClick={() => chooseStore(s)} style={{
                                            padding: 12, borderRadius: 10, background: 'var(--bg-tertiary)', cursor: 'pointer',
                                            border: selectedStore?.code === s.code ? '2px solid var(--accent-green)' : '2px solid transparent'
                                        }}>
                                            <div style={{ color: 'var(--accent-blue)', fontWeight: 700 }}>{s.code}</div>
                                            <div>{s.name}</div>
                                            <div style={{ color: '#888', fontSize: 12 }}>{s.count} articoli</div>
                                        </div>
                                    ))}
                                    {!filteredStores.length && <div style={{ color: '#888', fontSize: 13 }}>Nessun negozio trovato</div>}
                                </div>
                            </div>
                        )}

                        {step === 4 && (
                            <div className="card">
                                <div style={{ fontWeight: 600, marginBottom: 8 }}>üìã Riepilogo</div>
                                <div style={{ fontSize: 16, marginBottom: 8 }}>{selectedStore.code} - {selectedStore.name}</div>
                                <div className="summary-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12, marginBottom: 12 }}>
                                    <div className="summary-item" style={{ background: 'var(--bg-tertiary)', borderRadius: 10, padding: 12, textAlign: 'center' }}>
                                        <div className="summary-value" style={{ color: 'var(--accent-blue)' }}>{storeArticles.length}</div>
                                        <div className="summary-label" style={{ color: '#888', fontSize: 11 }}>Modelli unici</div>
                                    </div>
                                    <div className="summary-item" style={{ background: 'var(--bg-tertiary)', borderRadius: 10, padding: 12, textAlign: 'center' }}>
                                        <div className="summary-value">{storeArticles.reduce((s, a) => s + a.qty, 0)}</div>
                                        <div className="summary-label" style={{ color: '#888', fontSize: 11 }}>Pezzi totali</div>
                                    </div>
                                </div>
                                <div style={{ fontSize: 14, color: '#888', marginBottom: 8 }}>Anteprima articoli:</div>
                                <div style={{ maxHeight: 240, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: 8 }}>
                                    {storeArticles.slice(0, 20).map(a => (
                                        <div key={a.upc} style={{ display: 'flex', justifyContent: 'space-between', background: 'var(--bg-tertiary)', borderRadius: 8, padding: 10 }}>
                                            <div>
                                                <div style={{ fontWeight: 600 }}>{a.brand} <span style={{ color: '#888', fontSize: 12 }}>√ó{a.qty}</span></div>
                                                <div style={{ color: '#888', fontSize: 12 }}>{a.modello}</div>
                                                <div className="mono" style={{ color: '#666', fontSize: 11 }}>{a.upc}</div>
                                            </div>
                                            <div style={{ padding: '6px 10px', borderRadius: 6, background: 'rgba(0,230,118,0.15)', color: 'var(--accent-green)', fontWeight: 700 }}>
                                                -{a.sconto}%
                                            </div>
                                        </div>
                                    ))}
                                    {storeArticles.length > 20 && <div style={{ textAlign: 'center', color: '#888', fontSize: 12 }}>... altri {storeArticles.length - 20} articoli</div>}
                                </div>
                            </div>
                        )}
                    </div>

                    {step === 4 && (
                        <div style={{ padding: 16, borderTop: '1px solid #222', background: 'var(--bg-secondary)' }}>
                            <button data-testid="confirm-store" className="btn btn-primary w-full" onClick={confirmStore}>‚úÖ Conferma e salva</button>
                            <button className="btn btn-secondary w-full" style={{ marginTop: 8 }} onClick={() => setStep(3)}>‚Üê Cambia negozio</button>
                        </div>
                    )}
                </div>
            );
        }

        // ============================================================
        // APP
        // ============================================================
        function App() {
            const { view } = useApp();
            return (
                <>
                    <FeedbackOverlay />
                    {view === 'home' && <HomeView />}
                    {view === 'scanner' && <ScannerView />}
                    {view === 'history' && <HistoryView />}
                    {view === 'loader' && <CorporateLoader />}
                </>
            );
        }

        // ============================================================
        // RENDER
        // ============================================================
        ReactDOM.createRoot(document.getElementById('app')).render(
            <AppProvider><App /></AppProvider>
        );
    </script>
</body>
</html>
